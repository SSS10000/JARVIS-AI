<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‚ö° Realtime Data Share ‚Äî Pro (Ultra Fast)</title>

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <!-- Animate -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <!-- QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{ --indigo:#6366f1; --pink:#ec4899; --emerald:#10b981; --blue:#3b82f6 }
    body{ font-family:'Poppins',sans-serif; overflow-x:hidden }
    h1,h2{ font-family:'Orbitron',sans-serif }
    .bg-animated{ background: linear-gradient(120deg, #0ea5e9, #6366f1, #a855f7, #ec4899, #14b8a6); background-size:400% 400%; animation:gradientShift 18s ease infinite; min-height:100vh }
    @keyframes gradientShift{ 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }
    .glass{ backdrop-filter: blur(14px); background: rgba(255,255,255,.13); border: 1px solid rgba(255,255,255,.25); box-shadow: 0 20px 60px rgba(0,0,0,.25) }
    .card{ position:relative; overflow:hidden; background: rgba(255,255,255,.92); border-radius:16px; box-shadow:0 20px 45px rgba(0,0,0,.15); transition:transform .25s, box-shadow .25s }
    .card:before{ content:""; position:absolute; inset:-2px; background:conic-gradient(from 180deg at 50% 50%, rgba(99,102,241,.25), rgba(236,72,153,.22), rgba(20,184,166,.18), transparent 70%); filter: blur(16px); z-index:-1 }
    .f-input{ border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:.8rem }
    .btn{ border-radius:12px; padding:.7rem 1rem; font-weight:700; color:#fff; transition:transform .15s, box-shadow .15s; cursor:pointer }
    .btn-indigo{ background:linear-gradient(135deg,#6366f1,#a855f7) }
    .btn-green{ background:linear-gradient(135deg,#10b981,#22c55e) }
    .btn-blue{ background:linear-gradient(135deg,#3b82f6,#06b6d4) }
    .btn-light{ background:#eef2ff; color:#4f46e5; font-weight:600 }
    .progress{ height:10px; background:linear-gradient(90deg,var(--indigo),var(--pink)); border-radius:12px; width:0%; transition:width .2s linear }
    .loader-wrap{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10000; backdrop-filter: blur(6px) brightness(.9) }
    .spinner{ width:70px; height:70px; border-radius:50%; border:6px solid rgba(255,255,255,.35); border-top-color:#fff; animation:spin 1s linear infinite; box-shadow:0 0 40px rgba(255,255,255,.55) }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .toasts{ position:fixed; top:14px; right:14px; z-index:11000; display:flex; flex-direction:column; gap:10px }
    .toast{ min-width:260px; max-width:400px; padding:12px 14px; color:#fff; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.22); backdrop-filter: blur(8px) saturate(1.1) }
    .ok{ background:linear-gradient(135deg,#34d399,#10b981) } .err{ background:linear-gradient(135deg,#f87171,#ef4444) } .info{ background:linear-gradient(135deg,#60a5fa,#3b82f6) }
    .badge{ font-size:.72rem; padding:.22rem .55rem; border-radius:999px; background:rgba(255,255,255,.22); color:#fff }
    .dropzone{ border:2px dashed rgba(0,0,0,.12); border-radius:14px; padding:16px; transition:.18s }
    .dropzone.drag{ border-color:#60a5fa; background:rgba(96,165,250,.06) }
    .small{ font-size:.85rem }
    .history-item{ display:flex; align-items:center; justify-content:space-between; padding:.6rem .8rem; border-radius:12px; background:rgba(255,255,255,.75) }
    .dark .card{ background: rgba(17,24,39,.88); color:#e5e7eb; border:1px solid rgba(255,255,255,.05) }
  </style>
</head>
<body class="bg-animated">
  <!-- Loader -->
  <div id="loader" class="loader-wrap"><div class="spinner"></div></div>
  <!-- Toasts -->
  <div id="toasts" class="toasts"></div>

  <div class="glass w-full max-w-7xl mx-auto my-8 md:my-12 rounded-3xl p-6 md:p-10 animate__animated animate__fadeIn">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white drop-shadow">‚ö° Realtime Data Share ‚Äî Ultra Fast</h1>
        <span class="badge hidden md:inline">Storage ‚Ä¢ Metadata ‚Ä¢ Progress</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="darkToggle" class="btn btn-light px-4 py-2">üåô Dark</button>
        <a class="btn btn-blue px-4 py-2 text-white" href="https://console.firebase.google.com/" target="_blank" rel="noopener">Firebase</a>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Sender -->
      <div class="card p-6 space-y-4 lg:col-span-1">
        <div class="flex items-center gap-2">
          <span class="dot" style="background:var(--indigo);width:10px;height:10px;border-radius:999px;"></span>
          <h2 class="text-2xl text-indigo-700">üì§ Sender</h2>
        </div>

        <div class="grid gap-3">
          <div class="flex gap-2">
            <input id="senderId" class="f-input flex-1" placeholder="Custom ID (optional)"/>
            <button id="genId" class="btn btn-indigo">Generate</button>
            <button id="copyId" class="btn btn-light">Copy</button>
          </div>

          <div class="dropzone" id="dropzone">
            <div class="flex items-center justify-between">
              <div>
                <label class="block text-sm font-semibold">Select file (‚â§ 15 MB)</label>
                <input id="fileInput" type="file" class="w-full f-input mt-2" />
                <p id="fileInfo" class="text-xs opacity-80 mt-1"></p>
              </div>
              <div class="hidden md:block text-4xl">üìé</div>
            </div>
            <p class="text-xs mt-2">Tip: Drag & drop, or paste (Ctrl+V) an image/file here.</p>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <input id="passphrase" class="f-input" placeholder="Passphrase (optional - encryption)"/>
            <select id="expiry" class="f-input">
              <option value="600000">Expire 10 min</option>
              <option value="3600000">Expire 1 hour</option>
              <option value="86400000" selected>Expire 1 day</option>
              <option value="604800000">Expire 7 days</option>
            </select>
          </div>

          <label class="inline-flex items-center gap-2 small"><input id="oneTime" type="checkbox" /> Delete after first download (one-time)</label>

          <button id="sendBtn" class="btn btn-indigo w-full">üöÄ Send (Fast)</button>
          <div class="mt-2">
            <div class="progress" id="progress"></div>
            <div class="flex justify-between mt-1 small">
              <div id="progressLabel">0%</div>
              <div id="est">ETA: --</div>
            </div>
          </div>
          <p id="status" class="text-sm"></p>

          <div id="shareWrap" class="mt-3 hidden">
            <p class="text-sm mb-2">Share receiver link or scan QR:</p>
            <div class="flex gap-2 mb-3">
              <input id="shareLink" class="f-input flex-1 bg-white dark:bg-gray-900" readonly/>
              <button id="copyShare" class="btn btn-blue">Copy Link</button>
            </div>
            <div id="qrcode" class="p-3 bg-white dark:bg-gray-900 rounded-xl inline-block"></div>
          </div>
        </div>
      </div>

      <!-- Receiver -->
      <div class="card p-6 lg:col-span-1">
        <div class="flex items-center gap-2 mb-4"><span class="dot" style="background:var(--emerald);width:10px;height:10px;border-radius:999px;"></span><h2 class="text-2xl text-green-700">üì• Receiver</h2></div>
        <label class="block text-sm font-semibold mb-2">Enter ID to receive</label>
        <div class="flex gap-2 mb-4">
          <input id="receiverId" class="f-input flex-1" placeholder="ID to receive"/>
          <button id="openBtn" class="btn btn-green">üîç Open</button>
        </div>
        <div class="mb-3">
          <input id="recvPass" class="f-input" placeholder="Passphrase (if encrypted)"/>
        </div>
        <div id="receiveBox" class="space-y-3"></div>
      </div>

      <!-- History -->
      <div class="card p-6 lg:col-span-1">
        <div class="flex items-center gap-2 mb-4"><span class="dot" style="background:var(--blue);width:10px;height:10px;border-radius:999px;"></span><h2 class="text-2xl text-blue-700">üìú History</h2></div>
        <div class="flex gap-2 mb-4">
          <button id="tabSent" class="btn btn-light flex-1">Sent</button>
          <button id="tabRecv" class="btn btn-light flex-1">Received</button>
          <button id="clearHist" class="btn btn-light">Clear</button>
        </div>
        <div id="histList" class="space-y-2 max-h-80 overflow-auto pr-1"></div>
      </div>
    </div>
  </div>

  <!-- Firebase v10 (ES Modules) + Storage -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getDatabase, ref as dbRef, set, onValue, off, remove } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';
    import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

    /* ----------------- Put your Firebase config here ----------------- */
    const firebaseConfig = {
      apiKey: 'AIzaSyYOUR_KEY',
      authDomain: 'your-project.firebaseapp.com',
      databaseURL: 'https://your-project-default-rtdb.firebaseio.com',
      projectId: 'your-project',
      storageBucket: 'your-project.appspot.com',
      messagingSenderId: '0000000000',
      appId: '1:0000000000:web:xxxxxxxxxxxxxx'
    };
    /* ----------------------------------------------------------------- */

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const storage = getStorage(app);

    /* ---------------- UI shortcuts ---------------- */
    const $ = id => document.getElementById(id);
    const asMB = b => (b/1024/1024).toFixed(2)+' MB';
    const loader = $('loader'), showLoader = on => loader.style.display = on ? 'flex' : 'none';

    /* ---------------- Dark mode ---------------- */
    const DARK_KEY='rds-dark';
    function applyDark(on){ document.documentElement.classList.toggle('dark',on); document.body.classList.toggle('dark',on); $('darkToggle').textContent=on?'‚òÄÔ∏è Light':'üåô Dark'; localStorage.setItem(DARK_KEY,on?'1':'0') }
    $('darkToggle').addEventListener('click',()=>applyDark(!document.documentElement.classList.contains('dark')));
    (function(){ applyDark(localStorage.getItem(DARK_KEY)==='1') })();

    /* ---------------- Toasts + Ding ---------------- */
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    function ding(){ try{ const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(.0001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.25,ctx.currentTime+.02); g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.25); o.start(); o.stop(ctx.currentTime+.26) }catch(e){} }
    function toast(type,title,msg){
      const wrap=$('toasts'); const el=document.createElement('div');
      el.className=`toast ${type==='ok'?'ok':type==='err'?'err':'info'} animate__animated animate__fadeInRight`;
      el.innerHTML=`<div style="font-weight:800">${title}</div><div style="opacity:.95;margin-top:4px">${msg}</div>`;
      wrap.appendChild(el); ding();
      setTimeout(()=>{ el.classList.remove('animate__fadeInRight'); el.classList.add('animate__fadeOutRight'); setTimeout(()=>wrap.removeChild(el),600) }, 3000);
    }

    /* ---------------- History localStorage ---------------- */
    const HSENT='rds-h-sent', HREC='rds-h-recv';
    function getH(k){ try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(e){return[]} }
    function putH(k,a){ localStorage.setItem(k, JSON.stringify(a)) }
    function addSent(it){ const a=getH(HSENT); a.unshift(it); putH(HSENT,a); renderHist() }
    function addRecv(it){ const a=getH(HREC); a.unshift(it); putH(HREC,a); renderHist() }
    let histTab='sent';
    function renderHist(){
      const box=$('histList'); box.innerHTML='';
      const data = histTab==='sent'?getH(HSENT):getH(HREC);
      if(!data.length){ box.innerHTML = `<div class="text-sm opacity-75">${histTab==='sent'?'No sent items yet':'No received items yet'}</div>`; return; }
      data.slice(0,80).forEach(d=>{
        const row=document.createElement('div'); row.className='history-item';
        row.innerHTML = `<div><div class="font-semibold">${d.name} <span class="text-xs opacity-70">(${d.size||''})</span>${d.enc?'<span class="text-xs ml-1 px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700">E2E</span>':''}</div><div class="text-xs opacity-70">${d.time} ‚Ä¢ ID: ${d.id}</div></div><div class="flex gap-2">${d.link?`<a class="btn btn-blue px-3 py-2 text-white" href="${d.link}" target="_blank">Open</a>`:''}<button class="btn btn-light px-3 py-2" onclick="navigator.clipboard.writeText('${d.id}')">Copy ID</button></div>`;
        box.appendChild(row);
      });
    }
    $('tabSent').onclick=()=>{ histTab='sent'; renderHist() }
    $('tabRecv').onclick=()=>{ histTab='recv'; renderHist() }
    $('clearHist').onclick=()=>{ localStorage.removeItem(HSENT); localStorage.removeItem(HREC); renderHist(); toast('ok','Cleared','History removed') }
    renderHist();

    /* ---------------- Crypto helpers ---------------- */
    async function hexSha256(buffer){
      const hash = await crypto.subtle.digest('SHA-256', buffer);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function deriveKey(pass, salt){
      const enc = new TextEncoder();
      const keyMat = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:120000, hash:'SHA-256' }, keyMat, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
    }
    function ab2b64(buf){ let binary=''; const bytes=new Uint8Array(buf); for(let i=0;i<bytes.length;i++) binary+=String.fromCharCode(bytes[i]); return btoa(binary) }
    function b642ab(b64){ const binary=atob(b64); const buf=new ArrayBuffer(binary.length); const bytes=new Uint8Array(buf); for(let i=0;i<binary.length;i++) bytes[i]=binary.charCodeAt(i); return buf }

    async function encryptBytes(bytes, pass){
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(pass, salt);
      const cipher = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, bytes);
      return { cipherB64: ab2b64(cipher), ivB64: ab2b64(iv), saltB64: ab2b64(salt) };
    }

    async function decryptToBytes(cipherB64, pass, ivB64, saltB64){
      const salt = new Uint8Array(b642ab(saltB64));
      const iv = new Uint8Array(b642ab(ivB64));
      const key = await deriveKey(pass, salt);
      const plain = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, b642ab(cipherB64));
      return new Uint8Array(plain);
    }

    /* ---------------- Drag & Drop & Paste ---------------- */
    const dz = $('dropzone');
    ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{ e.preventDefault(); dz.classList.add('drag') }));
    ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{ e.preventDefault(); dz.classList.remove('drag') }));
    dz.addEventListener('drop', e=>{ const f = e.dataTransfer.files?.[0]; if(f){ const dt = new DataTransfer(); dt.items.add(f); $('fileInput').files = dt.files; updateFileInfo(f); }});
    window.addEventListener('paste', e=>{ const f=[...e.clipboardData.items].find(i=>i.kind==='file')?.getAsFile(); if(f){ const dt=new DataTransfer(); dt.items.add(f); $('fileInput').files=dt.files; updateFileInfo(f); toast('ok','Pasted','File captured from clipboard') }});

    /* ---------------- File info ---------------- */
    $('fileInput').addEventListener('change', e=>{ const f = e.target.files[0]; if(f) updateFileInfo(f) });
    function updateFileInfo(file){ $('fileInfo').textContent = `${file.name} ‚Ä¢ ${asMB(file.size)}` }

    /* ---------------- Pre-fill receiver from URL ---------------- */
    (function(){ const q = new URL(window.location.href).searchParams.get('id'); if(q){ $('receiverId').value = q; toast('info','ID from URL', q); startReceive(q) }})();

    /* ---------------- Utilities ---------------- */
    function randomId(n=8){ const s='abcdefghijklmnopqrstuvwxyz0123456789'; let r=''; for(let i=0;i<n;i++) r+=s[Math.floor(Math.random()*s.length)]; return r; }
    function copy(text){ navigator.clipboard.writeText(text).then(()=>toast('ok','Copied','Copied to clipboard')).catch(()=>toast('err','Copy Failed','Copy manually')) }
    function setShareLink(id){ const url=new URL(window.location.href); url.searchParams.set('id',id); $('shareLink').value = url.toString(); $('shareWrap').classList.remove('hidden'); $('qrcode').innerHTML=''; new QRCode('qrcode',{ text:url.toString(), width:140, height:140 }) }

    /* ---------------- Optional image compression (fast) ---------------- */
    async function compressImageIfNeeded(file, maxWidth = 1200, quality = 0.75){
      try{
        if(!file.type.startsWith('image/')) return file;
        // createImageBitmap and OffscreenCanvas are fast
        const img = await createImageBitmap(file);
        const ratio = Math.min(1, maxWidth / img.width);
        const canvas = new OffscreenCanvas(Math.round(img.width*ratio), Math.round(img.height*ratio));
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const blob = await canvas.convertToBlob({ type:'image/jpeg', quality });
        if(blob.size < file.size){
          return new File([blob], file.name.replace(/\.\w+$/, '.jpg'), { type:'image/jpeg' });
        }else return file;
      }catch(e){
        return file;
      }
    }

    /* ---------------- Sender actions & fast-storage upload ---------------- */
    $('genId').onclick = ()=>{ const id=randomId(8); $('senderId').value=id; copy(id); setShareLink(id) };
    $('copyId').onclick = ()=>{ const id=$('senderId').value.trim(); if(!id) return toast('err','No ID','Generate or type an ID'); copy(id); setShareLink(id) };
    $('copyShare').onclick = ()=>{ const v=$('shareLink').value; if(!v) return toast('err','No Link','Share link not ready'); copy(v) };

    let lastUploadTask = null;
    $('sendBtn').onclick = async () => {
      const f = $('fileInput').files[0]; if(!f) return toast('err','File Missing','Please choose a file');
      const MAX = 15 * 1024 * 1024; if(f.size > MAX) return toast('err','Too Large', `Please upload ‚â§ ${ (MAX/1024/1024).toFixed(0) } MB`);
      showLoader(true);
      $('progress').style.width = '4%'; $('progressLabel').textContent = 'Preparing...'; $('est').textContent = 'ETA: --'; $('status').textContent = '';

      try{
        // compress images quickly (optional)
        const compressed = await compressImageIfNeeded(f, 1400, 0.78);
        const file = compressed;
        const id = $('senderId').value.trim() || randomId(8); $('senderId').value = id;
        const pass = $('passphrase').value.trim();
        const expiryMs = parseInt($('expiry').value,10) || 86400000;
        const oneTime = !!$('oneTime').checked;

        // compute SHA-256
        $('status').textContent = 'Hashing...';
        const ab = await file.arrayBuffer();
        const sha = await hexSha256(ab);

        // if encryption requested: encrypt bytes and create Blob
        let uploadBlob = file;
        let encMeta = null;
        if(pass){
          $('status').textContent = 'Encrypting (client)...';
          const encRes = await encryptBytes(new Uint8Array(ab), pass);
          // store encrypted payload as binary: convert base64 back to ArrayBuffer
          const cipherBuf = b642ab(encRes.cipherB64); // ArrayBuffer
          uploadBlob = new Blob([cipherBuf], { type: 'application/octet-stream' });
          encMeta = { ivB64: encRes.ivB64, saltB64: encRes.saltB64 };
        }

        // storage ref
        const path = `files/${id}/${Date.now()}_${encodeURIComponent(file.name)}`;
        const sref = sRef(storage, path);

        // start resumable upload
        const metadata = { contentType: uploadBlob.type || file.type, customMetadata: { sha } };
        $('status').textContent = 'Uploading...';
        const uploadTask = uploadBytesResumable(sref, uploadBlob, metadata);
        lastUploadTask = uploadTask;

        const startTime = Date.now();
        let lastTransferred = 0;
        uploadTask.on('state_changed',
          (snapshot) => {
            const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            $('progress').style.width = pct + '%';
            $('progressLabel').textContent = pct + '%';
            // simple ETA estimator:
            const now = Date.now();
            const elapsed = (now - startTime) / 1000; // seconds
            const speed = snapshot.bytesTransferred / Math.max(elapsed, 0.2); // bytes/sec
            const remainingBytes = snapshot.totalBytes - snapshot.bytesTransferred;
            const eta = remainingBytes / (speed || 1);
            $('est').textContent = `ETA: ${eta < 60 ? Math.round(eta) + 's' : Math.round(eta/60)+'m'}`;
            lastTransferred = snapshot.bytesTransferred;
          },
          (err) => {
            console.error('Upload error', err);
            toast('err','Upload failed', err.message || 'Error during upload');
            showLoader(false);
          },
          async () => {
            // complete
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            // metadata to write in RTDB (small)
            const meta = {
              name: file.name,
              size: file.size,
              sha,
              url: downloadURL,
              storagePath: path,
              enc: !!pass,
              encMeta: encMeta || null,
              time: new Date().toISOString(),
              expiresAt: Date.now() + expiryMs,
              oneTime: !!oneTime
            };
            await set(dbRef(db, 'files/' + id), meta);

            $('progress').style.width = '100%'; $('progressLabel').textContent = '100%';
            $('status').innerHTML = `‚úÖ <b>${file.name}</b> sent with ID: <b>${id}</b>`;
            setShareLink(id);
            toast('ok','Upload successful', `ID: ${id} ‚Äî ready to share`);
            addSent({ id, name: file.name, time: new Date().toLocaleString(), size: asMB(file.size), link: location.origin + location.pathname + '?id=' + id, enc: !!pass });
            showLoader(false);
          }
        );

      }catch(e){
        console.error(e);
        toast('err','Send Error', e.message || 'Error');
        showLoader(false);
      }
    };

    /* ---------------- Receiver actions ---------------- */
    $('openBtn').onclick = ()=>{ const id = $('receiverId').value.trim(); if(!id) return toast('err','ID Missing','Type an ID first'); startReceive(id) };

    let currentRef = null;
    async function startReceive(id){
      const box = $('receiveBox'); box.innerHTML = `<div class="text-sm opacity-80">‚è≥ Listening for <b>${id}</b>...</div>`;
      if(currentRef) off(currentRef);
      currentRef = dbRef(db, 'files/' + id);
      onValue(currentRef, async snap => {
        const data = snap.val();
        if(!data){ box.innerHTML = `<div class="text-red-600 font-semibold">‚ùå No file for this ID</div>`; return; }
        if(data.expiresAt && Date.now() > data.expiresAt){ box.innerHTML = `<div class="text-red-600 font-semibold">‚è∞ Link expired</div>`; return; }

        const infoHTML = `<div class="font-semibold mb-1">üìÑ ${data.name} <span class="text-xs opacity-70">(${asMB(data.size||0)})</span>${data.enc?'<span class="text-xs ml-1 px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700">E2E</span>':''}</div><div class="text-xs opacity-70 mb-3">‚è± ${new Date(data.time).toLocaleString()} ‚Ä¢ ID: ${id}</div>`;
        const actionsHTML = `<div class="flex flex-wrap gap-2"><a id="dl" class="btn btn-blue px-4 py-2 text-white" href="#">‚¨á Download</a><button id="copyLink" class="btn btn-light px-4 py-2">Copy Link</button><button id="verifyBtn" class="btn btn-light px-4 py-2">Verify SHA-256</button></div>`;
        box.innerHTML = `<div class="p-4 rounded-xl bg-white dark:bg-gray-900 shadow animate__animated animate__fadeInUp">${infoHTML}${actionsHTML}<p id="verifyOut" class="text-xs mt-2 opacity-80"></p></div>`;

        const pass = $('recvPass').value.trim();

        async function downloadAndHandle(){
          try{
            $('status').textContent = 'Preparing download‚Ä¶';
            // If encrypted: we must download binary then decrypt client-side using encMeta
            if(data.enc){
              if(!pass) { toast('err','Passphrase required','Enter passphrase to decrypt'); return null; }
              // fetch binary
              const resp = await fetch(data.url);
              const arrBuf = await resp.arrayBuffer();
              // decrypt
              const plainBytes = await decryptToBytes(btoa(String.fromCharCode(...new Uint8Array(arrBuf))), pass, data.encMeta.ivB64, data.encMeta.saltB64)
              // plainBytes is Uint8Array ‚Äî create blob
              const blob = new Blob([plainBytes]);
              return { blob, name: data.name };
            }else{
              // not encrypted: download a direct URL (data stored in Storage)
              const resp = await fetch(data.url);
              const blob = await resp.blob();
              return { blob, name: data.name };
            }
          }catch(e){
            console.error(e);
            toast('err','Download failed', e.message || 'Error');
            return null;
          }
        }

        $('dl').onclick = async (ev) => {
          ev.preventDefault();
          const res = await downloadAndHandle();
          if(!res) return;
          const url = URL.createObjectURL(res.blob);
          const a = document.createElement('a'); a.href = url; a.download = res.name || 'download'; document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          toast('ok','Download successful','File downloaded');
          addRecv({ id, name: data.name, time: new Date().toLocaleString(), link: location.origin + location.pathname + '?id=' + id, enc: !!data.enc });
          // if oneTime: remove db meta and storage object
          if(data.oneTime){
            try{
              await remove(currentRef);
              // delete storage object (best-effort)
              const deleteRef = sRef(storage, data.storagePath);
              await deleteObject(deleteRef).catch(()=>{ /* ignore */ });
              toast('info','One-time','Link removed after download');
            }catch(e){ console.error('one-time cleanup failed', e) }
          }
        };

        $('copyLink').onclick = ()=>{ copy(data.url) };
        $('verifyBtn').onclick = async ()=>{
          try{
            $('verifyOut').textContent = 'Verifying‚Ä¶';
            const resp = await fetch(data.url);
            const ab = await resp.arrayBuffer();
            let bytes;
            if(data.enc){
              if(!pass){ toast('err','Passphrase required','Enter passphrase'); $('verifyOut').textContent=''; return; }
              bytes = await decryptToBytes(btoa(String.fromCharCode(...new Uint8Array(ab))), pass, data.encMeta.ivB64, data.encMeta.saltB64);
            }else bytes = new Uint8Array(ab);
            const h = await hexSha256(bytes.buffer);
            $('verifyOut').textContent = h === data.sha ? '‚úÖ Hash verified (SHA-256 matches)' : '‚ùå Hash mismatch';
          }catch(e){ $('verifyOut').textContent = '‚ùå Verification error'; console.error(e) }
        };
      });
    }

    /* ---------------- Keyboard shortcut ---------------- */
    window.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='i'){ e.preventDefault(); $('senderId').focus(); } });

    /* ---------------- Helper: base64 arrayBuffer for decrypt helper (used earlier) ---------------- */
    function b642ab_raw(b64){
      const binary = atob(b64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for(let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }

    // small helper wrapper used in decryptToBytes earlier (we sent base64 string)
    function b642ab(b64){
      // if input is ArrayBuffer-like already, return it
      try{ return b642ab_raw(b64); }catch(e){ return b642ab_raw(b64) }
    }

  </script>

  <!-- Notes & production tips:
    1) Replace firebaseConfig placeholders with your project's real values.
    2) Set Realtime DB + Storage rules to secure before production.
    3) For guaranteed cleanup of expired items, add a Cloud Function / scheduled job to delete expired storage blobs and DB metadata.
    4) Encryption is optional; it adds CPU time. Use for extra privacy.
    5) For consistent 5s target: encourage file sizes <= ~3MB and good upstream bandwidth.
  -->
</body>
</html>
